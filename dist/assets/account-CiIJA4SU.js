import"./supabaseClient-B0Gv5ww8.js";const l=window.sb,t=e=>document.getElementById(e);async function P(){const{data:{session:e}}=await l.auth.getSession();return e||(window.location.href="/login.html",null)}function O(e){if(!e)return"Usuario";const n=e.split("@")[0]||"Usuario";return n.charAt(0).toUpperCase()+n.slice(1)}function $(){const e=t("user-menu-button"),n=t("user-menu");if(!e||!n)return;const o=()=>n.classList.toggle("hidden");e.addEventListener("click",a=>{a.stopPropagation(),o()}),document.addEventListener("click",()=>n.classList.add("hidden")),document.addEventListener("keydown",a=>{a.key==="Escape"&&n.classList.add("hidden")})}function d(e,n,o){const a=document.createElement(e);return n&&(a.className=n),o&&(a.textContent=o),a}let x=[],C=[];async function U(){const e=t("ba-bank"),{data:n,error:o}=await l.from("banks").select("id,name").order("name");if(o){e&&(e.innerHTML='<option value="">—</option>');return}x=n||[],e&&(e.innerHTML=(x.length?x:[{id:"",name:"—"}]).map(a=>`<option value="${a.id}">${a.name}</option>`).join(""))}async function y(){const{data:{user:e}}=await l.auth.getUser();return e?.id||null}function B(e){return x.find(o=>o.id===e)?.name||"—"}async function A(){const e=await y();if(!e)return;const{data:n,error:o}=await l.from("bank_accounts").select("id,name,description,account_type,account_number,currency_code,initial_balance,bank_id,banks(name)").eq("user_id",e).order("created_at",{ascending:!1}),a=t("bank-accounts-tbody"),i=t("bank-accounts-empty"),s=t("bank-accounts-msg");if(o){a&&(a.innerHTML=`<tr><td colspan="5" class="px-4 py-4 text-red-400">${o.message}</td></tr>`),i&&i.classList.add("hidden");return}const m=n||[];if(!(!a||!i)){if(m.length===0){a.innerHTML="",i.classList.remove("hidden");return}i.classList.add("hidden"),a.innerHTML="",m.forEach(r=>{const p=r.banks?.name||B(r.bank_id),c=document.createElement("tr");c.appendChild(d("td","px-4 py-3",r.name||"—")),c.appendChild(d("td","px-4 py-3 capitalize",r.account_type||"—")),c.appendChild(d("td","px-4 py-3",r.currency_code||"COP")),c.appendChild(d("td","px-4 py-3",p));const u=d("td","px-4 py-3 text-right"),f=d("button","px-3 py-1 rounded-md border border-slate-700 hover:bg-slate-800 text-xs","Editar");f.setAttribute("data-ba-edit",r.id),u.appendChild(f),u.appendChild(document.createTextNode(" "));const b=d("button","px-3 py-1 rounded-md border border-rose-700 text-rose-300 hover:bg-rose-900/20 text-xs","Borrar");b.setAttribute("data-ba-del",r.id),u.appendChild(b),c.appendChild(u),a.appendChild(c)}),s&&(s.textContent="")}}function w(e){const n=t("bank-account-modal");n&&n.classList.toggle("hidden",!e)}function h(e,n){e?.classList.toggle("hidden",!n)}function N(e={}){t("ba-id").value=e.id||"",t("ba-name").value=e.name||"",t("ba-desc").value=e.description||"",t("ba-type").value=e.account_type||"ahorros",t("ba-number").value=e.account_number||"",t("ba-currency").value=e.currency_code||"COP",t("ba-initial").value=(e.initial_balance??"")===null?"":e.initial_balance??"",t("ba-bank").value=e.bank_id||x[0]?.id||"",t("bamodal-title").textContent=e.id?"Editar cuenta":"Agregar cuenta",t("bamodal-msg").textContent="",h(t("err-name"),!1),h(t("err-initial"),!1)}function D(){t("btn-new-bank-account")?.addEventListener("click",()=>{N(),w(!0)}),document.querySelectorAll("[data-close-bamodal]").forEach(e=>e.addEventListener("click",()=>w(!1))),t("bank-account-form")?.addEventListener("submit",F)}async function F(e){e.preventDefault();const n=await y();if(!n)return;const o=t("ba-id").value||void 0,a=t("ba-name").value.trim(),i=t("ba-desc").value.trim()||null,s=t("ba-type").value||"ahorros",m=t("ba-number").value.trim()||null,r=t("ba-currency").value||"COP",p=t("ba-initial").value.trim();let c=!0;if(h(t("err-name"),!1),h(t("err-initial"),!1),a||(h(t("err-name"),!0),c=!1),p!==""&&isNaN(Number(p))&&(h(t("err-initial"),!0),c=!1),!c)return;const u=p===""?null:Number(p),f=t("ba-bank").value||null,b={id:o,user_id:n,name:a,description:i,account_type:s,account_number:m,currency_code:r,initial_balance:u,bank_id:f},{error:g}=await l.from("bank_accounts").upsert(b).select("id").single();t("bamodal-msg").textContent=g?g.message:"Guardado ✅",g||(await A(),setTimeout(()=>w(!1),400))}async function G(e){const n=e.target.closest("[data-ba-edit]"),o=e.target.closest("[data-ba-del]");if(n){const a=n.getAttribute("data-ba-edit"),{data:i,error:s}=await l.from("bank_accounts").select("*").eq("id",a).single();if(s)return alert(s.message);N(i),w(!0);return}if(o){const a=o.getAttribute("data-ba-del");if(!confirm("¿Eliminar esta cuenta? Esta acción no se puede deshacer."))return;const{error:i}=await l.from("bank_accounts").delete().eq("id",a);if(i)return alert(i.message);await A()}}function I(){t("bank-accounts-tbody")?.addEventListener("click",G)}async function j(){const e=await y();if(!e)return;const n=t("po-account"),{data:o,error:a}=await l.from("bank_accounts").select("id,name,bank_id").eq("user_id",e).order("name");if(a){n&&(n.innerHTML='<option value="">—</option>');return}C=o||[],n&&(n.innerHTML='<option value="" disabled selected>Selecciona una cuenta…</option>'+C.map(i=>`<option value="${i.id}">${i.name}</option>`).join(""))}function R(e){return C.find(o=>o.id===e)?.name||"—"}function z(e){const n=C.find(o=>o.id===e);return B(n?.bank_id)}async function T(){const e=await y();if(!e)return;const{data:n,error:o}=await l.from("pockets").select("id,name,bank_account_id").eq("user_id",e).order("created_at",{ascending:!1}),a=t("pockets-tbody"),i=t("pockets-empty"),s=t("pockets-msg");if(o){a&&(a.innerHTML=`<tr><td colspan="4" class="px-4 py-4 text-red-400">${o.message}</td></tr>`),i&&i.classList.add("hidden");return}const m=n||[];if(!(!a||!i)){if(m.length===0){a.innerHTML="",i.classList.remove("hidden");return}i.classList.add("hidden"),a.innerHTML="",m.forEach(r=>{const p=R(r.bank_account_id),c=z(r.bank_account_id),u=document.createElement("tr");u.appendChild(d("td","px-4 py-3",r.name||"—")),u.appendChild(d("td","px-4 py-3",c)),u.appendChild(d("td","px-4 py-3",p));const f=d("td","px-4 py-3 text-right"),b=d("button","px-3 py-1 rounded-md border border-slate-700 hover:bg-slate-800 text-xs","Editar");b.setAttribute("data-po-edit",r.id),f.appendChild(b),f.appendChild(document.createTextNode(" "));const g=d("button","px-3 py-1 rounded-md border border-rose-700 text-rose-300 hover:bg-rose-900/20 text-xs","Borrar");g.setAttribute("data-po-del",r.id),f.appendChild(g),u.appendChild(f),a.appendChild(u)}),s&&(s.textContent="")}}function _(e){const n=t("pocket-modal");n&&n.classList.toggle("hidden",!e)}function v(e,n){e?.classList.toggle("hidden",!n)}function H(e={}){t("po-id").value=e.id||"",t("po-name").value=e.name||"",t("po-account").value=e.bank_account_id||"",t("pomodal-title").textContent=e.id?"Editar bolsillo":"Agregar bolsillo",t("pomodal-msg").textContent="",v(t("err-po-name"),!1),v(t("err-po-account"),!1)}function K(){t("btn-new-pocket")?.addEventListener("click",()=>{H(),_(!0)}),document.querySelectorAll("[data-close-pomodal]").forEach(e=>e.addEventListener("click",()=>_(!1))),t("pocket-form")?.addEventListener("submit",J)}async function J(e){e.preventDefault();const n=await y();if(!n)return;const o=t("po-id").value||void 0,a=t("po-name").value.trim(),i=t("po-account").value;let s=!0;if(v(t("err-po-name"),!1),v(t("err-po-account"),!1),a||(v(t("err-po-name"),!0),s=!1),i||(v(t("err-po-account"),!0),s=!1),!s)return;const m={id:o,user_id:n,name:a,bank_account_id:i,initial_amount:o?void 0:0},{error:r}=await l.from("pockets").upsert(m).select("id").single();t("pomodal-msg").textContent=r?r.message:"Guardado ✅",r||(await T(),setTimeout(()=>_(!1),400))}async function Q(e){const n=e.target.closest("[data-po-edit]"),o=e.target.closest("[data-po-del]");if(n){const a=n.getAttribute("data-po-edit"),{data:i,error:s}=await l.from("pockets").select("*").eq("id",a).single();if(s)return alert(s.message);H(i),_(!0);return}if(o){const a=o.getAttribute("data-po-del");if(!confirm("¿Eliminar este bolsillo? Esta acción no se puede deshacer."))return;const{error:i}=await l.from("pockets").delete().eq("id",a);if(i)return alert(i.message);await T()}}function V(){t("pockets-tbody")?.addEventListener("click",Q)}let L=[];async function W(){const e=t("sc-category"),{data:n,error:o}=await l.from("categories").select("id,name").order("name");if(o){e&&(e.innerHTML='<option value="">—</option>');return}L=n||[],e&&(e.innerHTML='<option value="" disabled selected>Selecciona una categoría…</option>'+L.map(a=>`<option value="${a.id}">${a.name}</option>`).join(""))}function X(e){return L.find(o=>o.id===e)?.name||"—"}async function M(){const e=await y();if(!e)return;const{data:n,error:o}=await l.from("subcategories").select("id,name,color,icon,category_id").eq("user_id",e).order("created_at",{ascending:!1}),a=t("subcategories-tbody"),i=t("subcategories-empty"),s=t("subcategories-msg");if(o){a&&(a.innerHTML=`<tr><td colspan="4" class="px-4 py-4 text-red-400">${o.message}</td></tr>`),i&&i.classList.add("hidden");return}const m=n||[];if(!(!a||!i)){if(m.length===0){a.innerHTML="",i.classList.remove("hidden");return}i.classList.add("hidden"),a.innerHTML="",m.forEach(r=>{const p=X(r.category_id),c=document.createElement("tr");c.appendChild(d("td","px-4 py-3",r.name||"—"));const u=d("td","px-4 py-3"),f=d("div","w-4 h-4 rounded-full");f.style.backgroundColor=r.color||"#ccc",u.appendChild(f),c.appendChild(u),c.appendChild(d("td","px-4 py-3",p));const b=d("td","px-4 py-3 text-right"),g=d("button","px-3 py-1 rounded-md border border-slate-700 hover:bg-slate-800 text-xs","Editar");g.setAttribute("data-sc-edit",r.id),b.appendChild(g),b.appendChild(document.createTextNode(" "));const S=d("button","px-3 py-1 rounded-md border border-rose-700 text-rose-300 hover:bg-rose-900/20 text-xs","Borrar");S.setAttribute("data-sc-del",r.id),b.appendChild(S),c.appendChild(b),a.appendChild(c)}),s&&(s.textContent="")}}function E(e){const n=t("subcategory-modal");n&&n.classList.toggle("hidden",!e)}function k(e,n){e?.classList.toggle("hidden",!n)}function q(e={}){t("sc-id").value=e.id||"",t("sc-name").value=e.name||"",t("sc-category").value=e.category_id||"",t("sc-icon").value=e.icon||"",t("sc-color").value=e.color||"#4f46e5",t("scmodal-title").textContent=e.id?"Editar subcategoría":"Agregar subcategoría",t("scmodal-msg").textContent="",k(t("err-sc-name"),!1),k(t("err-sc-category"),!1)}function Y(){t("btn-new-subcategory")?.addEventListener("click",()=>{q(),E(!0)}),document.querySelectorAll("[data-close-scmodal]").forEach(e=>e.addEventListener("click",()=>E(!1))),t("subcategory-form")?.addEventListener("submit",Z)}async function Z(e){e.preventDefault();const n=await y();if(!n)return;const o=t("sc-id").value||void 0,a=t("sc-name").value.trim(),i=t("sc-category").value,s=t("sc-icon").value.trim()||null,m=t("sc-color").value;let r=!0;if(k(t("err-sc-name"),!1),k(t("err-sc-category"),!1),a||(k(t("err-sc-name"),!0),r=!1),i||(k(t("err-sc-category"),!0),r=!1),!r)return;const p={id:o,user_id:n,name:a,category_id:i,icon:s,color:m},{error:c}=await l.from("subcategories").upsert(p).select("id").single();t("scmodal-msg").textContent=c?c.message:"Guardado ✅",c||(await M(),setTimeout(()=>E(!1),400))}async function ee(e){const n=e.target.closest("[data-sc-edit]"),o=e.target.closest("[data-sc-del]");if(n){const a=n.getAttribute("data-sc-edit"),{data:i,error:s}=await l.from("subcategories").select("*").eq("id",a).single();if(s)return alert(s.message);q(i),E(!0);return}if(o){const a=o.getAttribute("data-sc-del");if(!confirm("¿Eliminar esta subcategoría? Esta acción no se puede deshacer."))return;const{error:i}=await l.from("subcategories").delete().eq("id",a);if(i)return alert(i.message);await M()}}function te(){t("subcategories-tbody")?.addEventListener("click",ee)}async function ne(){const e=await P();if(!e)return;const n=e.user,o=n.user_metadata?.full_name||O(n.email),a=t("user-name-header");a&&(a.textContent=o||"Usuario"),$(),t("btn-logout")?.addEventListener("click",async()=>{await l.auth.signOut(),window.location.href="/index.html"}),l.auth.onAuthStateChange((i,s)=>{(i==="SIGNED_OUT"||!s)&&(window.location.href="/index.html")}),await U(),await A(),D(),I(),await j(),await T(),K(),V(),await W(),await M(),Y(),te()}ne();
